<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EggScan 文献智能分析系统 v2.0</title>
    <!-- (中文注释) 添加了你设计的浏览器标签页图标 (Favicon) -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%23F97316'/%3E%3Cpath d='M25 65 l25 -30 l25 30' stroke='%23FFFFFF' stroke-width='10' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* (中文注释) 使用更适合中文阅读的字体，并定义一些自定义样式 */
        body { font-family: 'Noto Sans SC', sans-serif; background-color: #f4f6f9; }
        .card { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.07), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .btn-primary { background: #3B82F6; transition: all 0.2s ease-in-out; }
        .btn-primary:hover { background: #2563EB; transform: translateY(-1px); }
        .btn-primary:disabled { background: #93C5FD; cursor: not-allowed; }
        .btn-download { background-color: #16A34A; }
        .btn-download:hover { background-color: #15803D; }
        .mode-card.active { border-color: #3B82F6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); }
        .progress-bar-inner { background: linear-gradient(to right, #60A5FA, #3B82F6); transition: width 0.4s ease-in-out; }
        .tips-card { background-color: #FEFCE8; border-left-color: #FACC15; }
        .result-item { border-left-color: #22C55E; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div class="card bg-white rounded-2xl p-8 md:p-12 w-full max-w-3xl">

        <!-- (中文注释) 标题区域，使用了你设计的带箭头Logo的样式 -->
        <div class="text-center mb-10">
            <div class="flex items-center justify-center">
                 <div class="w-12 h-12 bg-orange-500 rounded-full flex items-center justify-center mr-4 shadow-lg">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" /></svg>
                 </div>
                 <h1 class="text-4xl font-bold text-gray-800 tracking-tight">EggScan</h1>
            </div>
            <p class="text-lg text-gray-500 mt-2 font-medium">文献智能分析系统 v2.0 · 云端版</p>
        </div>

        <!-- (中文注释) 表单容器 -->
        <div id="form-container">
            <form id="upload-form" class="space-y-8">
                <!-- (中文注释) 步骤1: 上传文件 -->
                <div>
                    <label class="text-lg font-semibold text-gray-700 block mb-3">步骤 1: 上传PDF文献</label>
                    <div class="mt-1 flex justify-center px-6 py-10 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer hover:border-blue-400 transition bg-gray-50" id="drop-zone">
                        <div class="text-center">
                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                            <p id="file-list" class="mt-2 text-sm text-gray-600">点击或拖拽文件到此 (可多选)</p>
                        </div>
                        <input id="pdfs-input" name="pdfs" type="file" class="sr-only" multiple accept=".pdf">
                    </div>
                </div>
                <!-- (中文注释) ... 此处省略了API密钥、模式选择、语言等表单内容，代码结构与你成功运行的版本一致 ... -->
                <input type="hidden" id="mode-input" name="mode" value="经典模式">
                <div>
                    <label class="text-lg font-semibold text-gray-700 block mb-3">步骤 2: 输入API密钥</label>
                    <input type="password" id="api-key" name="api_key" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition" placeholder="请输入您的 DeepSeek API Key (sk-...)">
                    <div class="flex items-center mt-2"><input type="checkbox" id="remember-key" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"><label for="remember-key" class="ml-2 text-sm text-gray-600">在浏览器中保存密钥</label></div>
                </div>
                <div>
                    <label class="text-lg font-semibold text-gray-700 block mb-3">步骤 3: 选择分析模式</label>
                    <div id="mode-selector" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="mode-card active p-4 border-2 rounded-lg cursor-pointer hover:border-blue-400 transition" data-mode="经典模式"><span class="font-bold text-gray-800">📜 经典五段式</span><p class="text-sm text-gray-500 mt-1">快速构建文章框架。</p></div>
                        <div class="mode-card p-4 border-2 rounded-lg cursor-pointer hover:border-blue-400 transition" data-mode="精读模式"><span class="font-bold text-gray-800">📚 精读模式</span><p class="text-sm text-gray-500 mt-1">深度批判性分析。</p></div>
                        <div class="mode-card p-4 border-2 rounded-lg cursor-pointer hover:border-blue-400 transition" data-mode="自定义模式"><span class="font-bold text-gray-800">🎯 自定义模式</span><p class="text-sm text-gray-500 mt-1">按需定制分析维度。</p></div>
                    </div>
                </div>
                <div id="custom-prompt-container" class="hidden">
                    <label for="custom-prompt" class="text-lg font-semibold text-gray-700 block mb-3">自定义分析要求</label>
                    <textarea id="custom-prompt" name="custom_prompt" rows="6" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition" placeholder="请输入您的分析要求..."></textarea>
                </div>
                <div class="flex flex-col md:flex-row items-center gap-6">
                    <div>
                        <label for="language" class="text-lg font-semibold text-gray-700 block mb-2">步骤 4: 输出语言</label>
                        <select id="language" name="language" class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"><option value="中文">中文</option><option value="English">English</option></select>
                    </div>
                    <button type="submit" id="submit-btn" class="w-full md:flex-grow bg-blue-600 text-white font-bold py-4 px-8 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all duration-300 ease-in-out transform hover:scale-105">开始分析</button>
                </div>
            </form>
        </div>
        
        <!-- (中文注释) 这是你设计的、超酷的分析进度和结果显示容器，默认隐藏 -->
        <div id="result-container" class="hidden space-y-6">
            <div>
                <h2 class="text-xl font-bold text-gray-800">分析进度</h2>
                <div class="mt-3 w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                    <div id="progress-bar" class="progress-bar-inner h-full rounded-full text-center text-white text-xs" style="width: 0%;"></div>
                </div>
            </div>
            <div id="result-list" class="space-y-3 bg-gray-50 p-4 rounded-lg">
                <!-- 文件处理状态会动态插入到这里 -->
            </div>
            <div id="final-result" class="hidden text-center space-y-4">
                 <button id="download-btn" class="w-full md:w-auto inline-flex items-center justify-center px-8 py-3 rounded-lg font-semibold text-white btn-download shadow-lg hover:shadow-xl transition-all">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                     下载分析报告
                 </button>
            </div>
            <div id="tips-container" class="hidden tips-card border-l-4 p-4 rounded-r-lg">
                <h3 class="font-bold text-yellow-800 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-yellow-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                    使用提示
                </h3>
                <ul class="list-disc list-inside mt-2 text-sm text-gray-700 space-y-1 pl-1">
                    <li>经典模式适合快速筛选大量文献</li>
                    <li>精读模式适合深度分析重要文献</li>
                    <li>处理时间取决于文献数量和长度</li>
                    <li>建议每次处理不超过10篇文献</li>
                </ul>
            </div>
             <button id="reset-btn" class="w-full text-center text-sm text-gray-500 hover:text-blue-600 hover:underline mt-4">返回重新分析</button>
        </div>

    </div>
    <script>
        // (中文注释) 所有交互逻辑都封装在这里
        const formContainer = document.getElementById('form-container');
        const resultContainer = document.getElementById('result-container');
        const form = document.getElementById('upload-form');
        const submitBtn = document.getElementById('submit-btn');
        const dropZone = document.getElementById('drop-zone');
        const pdfsInput = document.getElementById('pdfs-input');
        const fileListDisplay = document.getElementById('file-list');
        const apiKeyInput = document.getElementById('api-key');
        const rememberKeyCheckbox = document.getElementById('remember-key');
        const modeSelector = document.getElementById('mode-selector');
        const modeInput = document.getElementById('mode-input');
        const customPromptContainer = document.getElementById('custom-prompt-container');
        
        const progressBar = document.getElementById('progress-bar');
        const resultList = document.getElementById('result-list');
        const finalResult = document.getElementById('final-result');
        const downloadBtn = document.getElementById('download-btn');
        const tipsContainer = document.getElementById('tips-container');
        const resetBtn = document.getElementById('reset-btn');
        let analysisResultBlob = null;

        // (中文注释) 页面加载时，自动读取已保存的API密钥
        window.addEventListener('load', () => {
            const savedKey = localStorage.getItem('eggscan_api_key');
            if (savedKey) { apiKeyInput.value = savedKey; rememberKeyCheckbox.checked = true; }
        });

        // (中文注释) 模式切换的核心逻辑
        modeSelector.addEventListener('click', (e) => {
            const selectedOption = e.target.closest('.mode-card');
            if (selectedOption) {
                modeSelector.querySelector('.active').classList.remove('active');
                selectedOption.classList.add('active');
                const selectedMode = selectedOption.dataset.mode;
                modeInput.value = selectedMode;
                customPromptContainer.classList.toggle('hidden', selectedMode !== '自定义模式');
            }
        });
        
        // (中文注释) 文件拖拽和选择的交互逻辑
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('border-blue-500'); });
        dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('border-blue-500'); });
        dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('border-blue-500'); pdfsInput.files = e.dataTransfer.files; updateFileList(); });
        dropZone.addEventListener('click', () => pdfsInput.click());
        pdfsInput.addEventListener('change', updateFileList);

        function updateFileList() {
            const fileCount = pdfsInput.files.length;
            fileListDisplay.textContent = fileCount > 0 ? `已选择 ${fileCount} 个文件` : '点击或拖拽文件到此 (可多选)';
        }

        // (中文注释) 表单提交的核心处理函数
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (rememberKeyCheckbox.checked) {
                localStorage.setItem('eggscan_api_key', apiKeyInput.value);
            } else {
                localStorage.removeItem('eggscan_api_key');
            }
            if (pdfsInput.files.length === 0) { alert('请至少上传一个PDF文件。'); return; }

            formContainer.classList.add('hidden');
            resultContainer.classList.remove('hidden');
            finalResult.classList.add('hidden');
            tipsContainer.classList.add('hidden');
            
            const totalFiles = pdfsInput.files.length;
            resultList.innerHTML = `<div class="text-sm text-gray-600">共 ${totalFiles} 个文件，正在提交任务...</div>`;
            progressBar.style.width = '5%';

            try {
                const formData = new FormData(form);
                progressBar.style.width = '20%';
                resultList.innerHTML += `<div class="text-sm text-gray-600 mt-2">正在分析，请耐心等待... (这可能需要几分钟)</div>`;

                const response = await fetch('/analyze', { method: 'POST', body: formData });
                
                progressBar.style.width = '90%';

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `服务器错误: ${response.status}`);
                }
                
                resultList.innerHTML = `<div class="result-item p-3 bg-green-50 rounded-lg text-sm text-green-700 font-semibold">✓ 分析完成！报告已生成</div>`;
                analysisResultBlob = await response.blob();
                finalResult.classList.remove('hidden');
                tipsContainer.classList.remove('hidden');
                progressBar.style.width = '100%';

            } catch (error) {
                resultList.innerHTML = `<div class="p-3 bg-red-100 border-l-4 border-red-500 rounded-lg text-red-700 font-semibold">❌ 分析出错: ${error.message}</div>`;
                progressBar.style.width = '100%';
                progressBar.style.backgroundColor = '#EF4444';
            }
        });

        // (中文注释) 下载按钮的点击事件
        downloadBtn.addEventListener('click', () => {
            if (analysisResultBlob) {
                const url = window.URL.createObjectURL(analysisResultBlob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'EggScan_Analysis_Result.xlsx';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            }
        });

        // (中文注释) 返回按钮的点击事件
        resetBtn.addEventListener('click', () => {
            formContainer.classList.remove('hidden');
            resultContainer.classList.add('hidden');
            pdfsInput.value = '';
            updateFileList();
            progressBar.style.width = '0%';
            progressBar.style.backgroundColor = '';
        });
    </script>
</body>
</html>

