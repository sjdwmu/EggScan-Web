<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EggScan 文献智能分析系统 v2.2</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23F59E0B' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M12 22c-5 0-9-4.5-9-10 0-2.5 1-5 2.5-6.5C7 4 8.5 2 12 2c3.5 0 5 2 6.5 3.5C20 7 21 9.5 21 12c0 5.5-4 10-9 10z'/%3E%3Cpath d='m10 14 2-2 2 2'/%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* antd: 【中文注释】使用更适合中文阅读的字体 */
        body { font-family: 'Noto Sans SC', sans-serif; }
        /* antd: 【中文注释】自定义加载动画 */
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #5B9BD5;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* antd: 【中文注释】进度条样式 */
        .progress-bar {
            background-color: #e9ecef;
            border-radius: 0.375rem;
            overflow: hidden;
        }
        .progress-bar-inner {
            background-color: #5B9BD5;
            height: 100%;
            transition: width 0.4s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
        <div class="bg-white rounded-2xl shadow-2xl p-8 md:p-12">
            
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-800 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block h-10 w-10 mr-3 text-amber-500">
                        <path d="M12 22c-5 0-9-4.5-9-10 0-2.5 1-5 2.5-6.5C7 4 8.5 2 12 2c3.5 0 5 2 6.5 3.5C20 7 21 9.5 21 12c0 5.5-4 10-9 10z"/>
                        <path d="m10 14 2-2 2 2"/>
                    </svg>
                    EggScan
                </h1>
                <p class="text-lg text-gray-500 mt-2">文献智能分析系统 v2.2 · 云端版</p>
            </div>

            <form id="upload-form" class="space-y-8">
                
                <div>
                    <label class="text-lg font-semibold text-gray-700 block mb-3">步骤 1: 上传PDF文献</label>
                    <div class="flex items-center space-x-4">
                        <label for="pdfs-input" class="cursor-pointer w-full md:w-auto bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all duration-300 ease-in-out text-center">
                            + 添加文件
                        </label>
                        <input type="file" id="pdfs-input" name="pdfs" multiple class="hidden">
                        
                        <button type="button" id="clear-files-btn" class="w-full md:w-auto bg-red-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-600 focus:outline-none focus:ring-4 focus:ring-red-300 transition-all">
                            清空列表
                        </button>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">可以多次点击“添加文件”从不同文件夹选择。最大总上传大小: 100MB。</p>
                    
                    <div id="file-list" class="mt-4 max-h-40 overflow-y-auto bg-gray-50 p-3 rounded-lg border text-sm">
                        <p class="text-gray-400">尚未选择任何文件</p>
                    </div>
                </div>

                <div>
                    <label for="apiKey" class="text-lg font-semibold text-gray-700 block mb-3">步骤 2: 输入API密钥</label>
                    <input type="password" id="apiKey" name="apiKey" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                           placeholder="请输入您的 DeepSeek API Key (sk-...)">
                    <div class="flex items-center mt-2">
                        <input type="checkbox" id="saveKey" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <label for="saveKey" class="ml-2 text-sm text-gray-600">在浏览器中保存密钥</label>
                    </div>
                </div>

                <div>
                    <label class="text-lg font-semibold text-gray-700 block mb-3">步骤 3: 选择分析模式</label>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- ===================================================================== -->
                        <!-- ---【文本修改】--- -->
                        <label class="p-4 border rounded-lg cursor-pointer hover:bg-gray-50 transition has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400 has-[:checked]:ring-2 has-[:checked]:ring-blue-300">
                            <input type="radio" name="mode" value="泛读模式" class="sr-only" checked>
                            <span class="font-bold text-gray-800">📜 泛读模式</span>
                            <p class="text-sm text-gray-500 mt-1">快速筛选文献，提取核心价值。</p>
                        </label>
                        <!-- ---【文本修改结束】--- -->
                        <!-- ===================================================================== -->
                        <label class="p-4 border rounded-lg cursor-pointer hover:bg-gray-50 transition has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400 has-[:checked]:ring-2 has-[:checked]:ring-blue-300">
                            <input type="radio" name="mode" value="精读模式" class="sr-only">
                            <span class="font-bold text-gray-800">📚 精读模式</span>
                            <p class="text-sm text-gray-500 mt-1">深度批判性分析，获取研究启发。</p>
                        </label>
                        <label class="p-4 border rounded-lg cursor-pointer hover:bg-gray-50 transition has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400 has-[:checked]:ring-2 has-[:checked]:ring-blue-300">
                            <input type="radio" name="mode" value="自定义模式" class="sr-only">
                            <span class="font-bold text-gray-800">🎯 自定义模式</span>
                            <p class="text-sm text-gray-500 mt-1">按需定制分析维度。</p>
                        </label>
                    </div>
                </div>

                <div id="custom-prompt-container" class="hidden">
                    <label for="customPrompt" class="text-lg font-semibold text-gray-700 block mb-3">自定义分析要求</label>
                    <textarea id="customPrompt" name="customPrompt" rows="8"
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                              placeholder="请输入您的分析要求，例如：&#10;【研究主题】：...&#10;【方法创新】：...&#10;请使用【字段名】：内容 的格式。"></textarea>
                </div>

                <div class="flex flex-col md:flex-row items-center gap-6">
                    <div>
                        <label for="language" class="text-lg font-semibold text-gray-700 block mb-2">步骤 4: 输出语言</label>
                        <select id="language" name="language" class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="中文">中文</option>
                            <option value="English">English</option>
                        </select>
                    </div>
                    <button type="submit" id="submit-btn"
                            class="w-full md:w-auto bg-blue-600 text-white font-bold py-4 px-8 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all duration-300 ease-in-out transform hover:scale-105">
                        开始分析
                    </button>
                </div>
            </form>
            
            <div class="mt-8 p-5 bg-amber-50 rounded-lg border-l-4 border-amber-400">
                <h3 class="text-lg font-bold text-amber-700 mb-3 flex items-center">
                    💡 使用提示
                </h3>
                <ul class="list-none p-0 space-y-2 text-gray-600 text-sm">
                    <li class="flex items-start"><span class="text-amber-500 font-bold mr-2">✓</span> <span>点击“添加文件”可从不同文件夹多次选择文件。</span></li>
                    <li class="flex items-start"><span class="text-amber-500 font-bold mr-2">✓</span> <span>为避免超时，建议每次处理不超过5篇文献。</span></li>
                    <li class="flex items-start"><span class="text-amber-500 font-bold mr-2">✓</span> <span>处理时间取决于文献数量、长度及网络状况。</span></li>
                </ul>
            </div>
            
            <div id="loader" class="hidden text-center mt-8 space-y-4">
                <div class="loader mx-auto"></div>
                <p id="status-text" class="text-gray-600 font-medium">正在初始化...</p>
                <div class="progress-bar w-full h-2.5">
                    <div id="progress-bar-inner" class="progress-bar-inner w-0"></div>
                </div>
                <div id="progress-messages" class="mt-4 max-h-48 overflow-y-auto bg-gray-50 p-3 rounded-md border text-sm text-left text-gray-700 leading-relaxed shadow-inner">
                </div>
                <p class="text-sm text-gray-400">(大型或扫描版PDF可能需要几分钟时间)</p>
            </div>
            
            <div id="error-message" class="hidden mt-6 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg" role="alert">
                <p class="font-bold">分析出错</p>
                <p id="error-text"></p>
            </div>
        </div>
    </div>

    <script>
        // 【中文注释】获取所有需要的DOM元素
        const form = document.getElementById('upload-form');
        const fileInput = document.getElementById('pdfs-input');
        const fileListDiv = document.getElementById('file-list');
        const clearFilesBtn = document.getElementById('clear-files-btn');
        const submitBtn = document.getElementById('submit-btn');
        const loader = document.getElementById('loader');
        const statusText = document.getElementById('status-text');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const apiKeyInput = document.getElementById('apiKey');
        const saveKeyCheckbox = document.getElementById('saveKey');
        const customPromptContainer = document.getElementById('custom-prompt-container');
        const customPromptTextarea = document.getElementById('customPrompt');
        const modeRadios = document.querySelectorAll('input[name="mode"]');
        const progressBarInner = document.getElementById('progress-bar-inner');
        const progressMessages = document.getElementById('progress-messages');
        
        let totalFiles = []; 

        function updateFileList() {
            if (totalFiles.length === 0) {
                fileListDiv.innerHTML = '<p class="text-gray-400">尚未选择任何文件</p>';
                return;
            }
            fileListDiv.innerHTML = '';
            const list = document.createElement('ul');
            list.className = 'list-disc pl-5 space-y-1 text-gray-600';
            totalFiles.forEach((file, index) => {
                const listItem = document.createElement('li');
                listItem.textContent = file.name;
                list.appendChild(listItem);
            });
            fileListDiv.appendChild(list);
        }

        fileInput.addEventListener('change', (e) => {
            totalFiles.push(...e.target.files);
            updateFileList();
            e.target.value = ''; 
        });

        clearFilesBtn.addEventListener('click', () => {
            totalFiles = [];
            updateFileList();
        });
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData();
            
            if (totalFiles.length === 0) {
                showError('请至少选择一个PDF文件。');
                return;
            }
            totalFiles.forEach(file => {
                formData.append('pdfs', file);
            });

            formData.append('apiKey', apiKeyInput.value);
            formData.append('language', document.getElementById('language').value);
            const selectedMode = document.querySelector('input[name="mode"]:checked');
            if (selectedMode) {
                formData.append('mode', selectedMode.value);
            }
            if (selectedMode && selectedMode.value === '自定义模式') {
                formData.append('customPrompt', customPromptTextarea.value);
            }
            
            if (!apiKeyInput.value.startsWith('sk-')) {
                showError('请输入一个有效的DeepSeek API密钥。');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = '分析中...';
            loader.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            progressMessages.innerHTML = ''; 

            updateProgress(0, '正在初始化...');
            addProgressMessage('任务已提交，正在初始化...');

            try {
                await simulateProgress(totalFiles.length);
                
                const response = await fetch('/analyze', {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || '服务器返回了一个未知错误。');
                }
                
                updateProgress(100, '分析完成！正在准备下载...');
                addProgressMessage('✅ 分析成功! 报告已生成，即将开始下载。'); 
                
                const blob = await response.blob();
                const header = response.headers.get('Content-Disposition');
                const parts = header.split(';');
                let filename = 'EggScan_Report.xlsx';
                for (const part of parts) {
                    if (part.trim().startsWith('filename=')) {
                        filename = part.substring(part.indexOf('=') + 1).trim();
                        filename = decodeURIComponent(filename.replace(/['"]/g, ''));
                        break;
                    }
                }
                
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

            } catch (error) {
                let friendlyErrorMessage = '分析失败，请稍后重试。';
                if (error instanceof TypeError && (error.message.includes('Failed to fetch') || error.message.includes('NetworkError'))) {
                    friendlyErrorMessage = '网络连接错误。\n这很可能是因为分析时间过长导致连接超时。\n\n您可以尝试以下操作：\n1. 检查您的网络连接。\n2. 尝试一次只分析一个文件，特别是对于扫描版或非常大的PDF。\n3. 如果在服务器部署，请检查Web服务器（如Gunicorn）的超时设置。';
                } else {
                    friendlyErrorMessage = error.message;
                }
                showError(friendlyErrorMessage);
                updateProgress(0, '出现错误');
                addProgressMessage(`❌ 分析失败: ${error.message}`);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '开始分析';
                setTimeout(() => {
                    loader.classList.add('hidden');
                }, 2000);
            }
        });

        function addProgressMessage(message) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'mb-1 py-1 px-2 border-l-4 border-gray-300';
            if (message.includes('成功') || message.includes('✅')) {
                msgDiv.className = 'mb-1 py-1 px-2 border-l-4 border-green-500 bg-green-50';
            } else if (message.includes('失败') || message.includes('❌')) {
                msgDiv.className = 'mb-1 py-1 px-2 border-l-4 border-red-500 bg-red-50';
            }
            msgDiv.textContent = message;
            progressMessages.appendChild(msgDiv);
            progressMessages.scrollTop = progressMessages.scrollHeight;
        }
        function updateProgress(percentage, text) {
            progressBarInner.style.width = `${percentage}%`;
            statusText.textContent = text;
        }
        function simulateProgress(fileCount) { /* ... 保持不变 ... */ return new Promise(resolve => {setTimeout(() => {updateProgress(15,`正在上传 ${fileCount} 个文件...`);addProgressMessage(`[1/3] 文件上传中...`);let analyzedFiles=0;addProgressMessage(`[2/3] 开始逐篇分析文献...`);const analysisInterval=setInterval(() => {if(analyzedFiles>=fileCount){clearInterval(analysisInterval);updateProgress(95,'正在生成Excel报告...');addProgressMessage('[3/3] 所有文件分析完毕，正在生成最终报告...');resolve();return;}
        analyzedFiles++;const progressPerFile=80/fileCount;let currentProgress=15+analyzedFiles*progressPerFile;updateProgress(Math.min(95,currentProgress),`正在分析第 ${analyzedFiles}/${fileCount} 篇文献...`);addProgressMessage(`  - 正在处理文献 #${analyzedFiles}`);},2000);},1000);});}
        function showError(message) {
            errorText.innerHTML = message.replace(/\n/g, '<br>');
            errorMessage.classList.remove('hidden');
        }
        const savedApiKey=localStorage.getItem('eggscan_api_key');if(savedApiKey){apiKeyInput.value=savedApiKey;saveKeyCheckbox.checked=true;}
        saveKeyCheckbox.addEventListener('change', () => {if(saveKeyCheckbox.checked){localStorage.setItem('eggscan_api_key',apiKeyInput.value);}else{localStorage.removeItem('eggscan_api_key');}});
        apiKeyInput.addEventListener('input', () => {if(saveKeyCheckbox.checked){localStorage.setItem('eggscan_api_key',apiKeyInput.value);}});
        const defaultCustomPrompt='请从以下角度分析这篇文献：\n\n【研究主题】：文章的核心研究问题是什么？\n【理论框架】：使用了什么理论基础或概念框架？\n【方法创新】：在研究方法上有什么创新或特色？\n【数据质量】：数据来源、样本量、统计分析的可靠性如何？\n【关键发现】：最重要的3个研究发现是什么？\n【实践意义】：对临床实践或政策制定有什么指导意义？\n【争议与讨论】：存在哪些争议点或值得进一步讨论的问题？\n【引用价值】：这篇文章最值得引用的观点或数据是什么？\n\n请用【字段名】：内容 的格式清晰输出。';modeRadios.forEach(radio=>{radio.addEventListener('change',()=>{if(radio.value==='自定义模式'){customPromptContainer.classList.remove('hidden');if(customPromptTextarea.value.trim()===''){customPromptTextarea.value=defaultCustomPrompt;}}else{customPromptContainer.classList.add('hidden');}});});
    </script>
</body>
</html>

