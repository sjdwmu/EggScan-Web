<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EggScan æ–‡çŒ®æ™ºèƒ½åˆ†æç³»ç»Ÿ v2.0</title>
    <!-- (ä¸­æ–‡æ³¨é‡Š) æ·»åŠ äº†ä½ è®¾è®¡çš„æµè§ˆå™¨æ ‡ç­¾é¡µå›¾æ ‡ (Favicon) -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%23F97316'/%3E%3Cpath d='M25 65 l25 -30 l25 30' stroke='%23FFFFFF' stroke-width='10' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* (ä¸­æ–‡æ³¨é‡Š) ä½¿ç”¨æ›´é€‚åˆä¸­æ–‡é˜…è¯»çš„å­—ä½“ï¼Œå¹¶å®šä¹‰ä¸€äº›è‡ªå®šä¹‰æ ·å¼ */
        body { font-family: 'Noto Sans SC', sans-serif; background-color: #f4f6f9; }
        .card { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.07), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .btn-primary { background: #3B82F6; transition: all 0.2s ease-in-out; }
        .btn-primary:hover { background: #2563EB; transform: translateY(-1px); }
        .btn-primary:disabled { background: #93C5FD; cursor: not-allowed; }
        .btn-download { background-color: #16A34A; }
        .btn-download:hover { background-color: #15803D; }
        .mode-card.active { border-color: #3B82F6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); }
        .progress-bar-inner { background: linear-gradient(to right, #60A5FA, #3B82F6); transition: width 0.4s ease-in-out; }
        .tips-card { background-color: #FEFCE8; border-left-color: #FACC15; }
        .result-item { border-left-color: #22C55E; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div class="card bg-white rounded-2xl p-8 md:p-12 w-full max-w-3xl">

        <!-- (ä¸­æ–‡æ³¨é‡Š) æ ‡é¢˜åŒºåŸŸï¼Œä½¿ç”¨äº†ä½ è®¾è®¡çš„å¸¦ç®­å¤´Logoçš„æ ·å¼ -->
        <div class="text-center mb-10">
            <div class="flex items-center justify-center">
                 <div class="w-12 h-12 bg-orange-500 rounded-full flex items-center justify-center mr-4 shadow-lg">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" /></svg>
                 </div>
                 <h1 class="text-4xl font-bold text-gray-800 tracking-tight">EggScan</h1>
            </div>
            <p class="text-lg text-gray-500 mt-2 font-medium">æ–‡çŒ®æ™ºèƒ½åˆ†æç³»ç»Ÿ v2.0 Â· äº‘ç«¯ç‰ˆ</p>
        </div>

        <!-- (ä¸­æ–‡æ³¨é‡Š) è¡¨å•å®¹å™¨ -->
        <div id="form-container">
            <form id="upload-form" class="space-y-8">
                <!-- (ä¸­æ–‡æ³¨é‡Š) æ­¥éª¤1: ä¸Šä¼ æ–‡ä»¶ -->
                <div>
                    <label class="text-lg font-semibold text-gray-700 block mb-3">æ­¥éª¤ 1: ä¸Šä¼ PDFæ–‡çŒ®</label>
                    <div class="mt-1 flex justify-center px-6 py-10 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer hover:border-blue-400 transition bg-gray-50" id="drop-zone">
                        <div class="text-center">
                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                            <p id="file-list" class="mt-2 text-sm text-gray-600">ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤ (å¯å¤šé€‰)</p>
                        </div>
                        <input id="pdfs-input" name="pdfs" type="file" class="sr-only" multiple accept=".pdf">
                    </div>
                </div>
                <!-- (ä¸­æ–‡æ³¨é‡Š) ... æ­¤å¤„çœç•¥äº†APIå¯†é’¥ã€æ¨¡å¼é€‰æ‹©ã€è¯­è¨€ç­‰è¡¨å•å†…å®¹ï¼Œä»£ç ç»“æ„ä¸ä½ æˆåŠŸè¿è¡Œçš„ç‰ˆæœ¬ä¸€è‡´ ... -->
                <input type="hidden" id="mode-input" name="mode" value="ç»å…¸æ¨¡å¼">
                <div>
                    <label class="text-lg font-semibold text-gray-700 block mb-3">æ­¥éª¤ 2: è¾“å…¥APIå¯†é’¥</label>
                    <input type="password" id="api-key" name="api_key" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition" placeholder="è¯·è¾“å…¥æ‚¨çš„ DeepSeek API Key (sk-...)">
                    <div class="flex items-center mt-2"><input type="checkbox" id="remember-key" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"><label for="remember-key" class="ml-2 text-sm text-gray-600">åœ¨æµè§ˆå™¨ä¸­ä¿å­˜å¯†é’¥</label></div>
                </div>
                <div>
                    <label class="text-lg font-semibold text-gray-700 block mb-3">æ­¥éª¤ 3: é€‰æ‹©åˆ†ææ¨¡å¼</label>
                    <div id="mode-selector" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="mode-card active p-4 border-2 rounded-lg cursor-pointer hover:border-blue-400 transition" data-mode="ç»å…¸æ¨¡å¼"><span class="font-bold text-gray-800">ğŸ“œ ç»å…¸äº”æ®µå¼</span><p class="text-sm text-gray-500 mt-1">å¿«é€Ÿæ„å»ºæ–‡ç« æ¡†æ¶ã€‚</p></div>
                        <div class="mode-card p-4 border-2 rounded-lg cursor-pointer hover:border-blue-400 transition" data-mode="ç²¾è¯»æ¨¡å¼"><span class="font-bold text-gray-800">ğŸ“š ç²¾è¯»æ¨¡å¼</span><p class="text-sm text-gray-500 mt-1">æ·±åº¦æ‰¹åˆ¤æ€§åˆ†æã€‚</p></div>
                        <div class="mode-card p-4 border-2 rounded-lg cursor-pointer hover:border-blue-400 transition" data-mode="è‡ªå®šä¹‰æ¨¡å¼"><span class="font-bold text-gray-800">ğŸ¯ è‡ªå®šä¹‰æ¨¡å¼</span><p class="text-sm text-gray-500 mt-1">æŒ‰éœ€å®šåˆ¶åˆ†æç»´åº¦ã€‚</p></div>
                    </div>
                </div>
                <div id="custom-prompt-container" class="hidden">
                    <label for="custom-prompt" class="text-lg font-semibold text-gray-700 block mb-3">è‡ªå®šä¹‰åˆ†æè¦æ±‚</label>
                    <textarea id="custom-prompt" name="custom_prompt" rows="6" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition" placeholder="è¯·è¾“å…¥æ‚¨çš„åˆ†æè¦æ±‚..."></textarea>
                </div>
                <div class="flex flex-col md:flex-row items-center gap-6">
                    <div>
                        <label for="language" class="text-lg font-semibold text-gray-700 block mb-2">æ­¥éª¤ 4: è¾“å‡ºè¯­è¨€</label>
                        <select id="language" name="language" class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"><option value="ä¸­æ–‡">ä¸­æ–‡</option><option value="English">English</option></select>
                    </div>
                    <button type="submit" id="submit-btn" class="w-full md:flex-grow bg-blue-600 text-white font-bold py-4 px-8 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all duration-300 ease-in-out transform hover:scale-105">å¼€å§‹åˆ†æ</button>
                </div>
            </form>
        </div>
        
        <!-- (ä¸­æ–‡æ³¨é‡Š) è¿™æ˜¯ä½ è®¾è®¡çš„ã€è¶…é…·çš„åˆ†æè¿›åº¦å’Œç»“æœæ˜¾ç¤ºå®¹å™¨ï¼Œé»˜è®¤éšè— -->
        <div id="result-container" class="hidden space-y-6">
            <div>
                <h2 class="text-xl font-bold text-gray-800">åˆ†æè¿›åº¦</h2>
                <div class="mt-3 w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                    <div id="progress-bar" class="progress-bar-inner h-full rounded-full text-center text-white text-xs" style="width: 0%;"></div>
                </div>
            </div>
            <div id="result-list" class="space-y-3 bg-gray-50 p-4 rounded-lg">
                <!-- æ–‡ä»¶å¤„ç†çŠ¶æ€ä¼šåŠ¨æ€æ’å…¥åˆ°è¿™é‡Œ -->
            </div>
            <div id="final-result" class="hidden text-center space-y-4">
                 <button id="download-btn" class="w-full md:w-auto inline-flex items-center justify-center px-8 py-3 rounded-lg font-semibold text-white btn-download shadow-lg hover:shadow-xl transition-all">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                     ä¸‹è½½åˆ†ææŠ¥å‘Š
                 </button>
            </div>
            <div id="tips-container" class="hidden tips-card border-l-4 p-4 rounded-r-lg">
                <h3 class="font-bold text-yellow-800 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-yellow-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                    ä½¿ç”¨æç¤º
                </h3>
                <ul class="list-disc list-inside mt-2 text-sm text-gray-700 space-y-1 pl-1">
                    <li>ç»å…¸æ¨¡å¼é€‚åˆå¿«é€Ÿç­›é€‰å¤§é‡æ–‡çŒ®</li>
                    <li>ç²¾è¯»æ¨¡å¼é€‚åˆæ·±åº¦åˆ†æé‡è¦æ–‡çŒ®</li>
                    <li>å¤„ç†æ—¶é—´å–å†³äºæ–‡çŒ®æ•°é‡å’Œé•¿åº¦</li>
                    <li>å»ºè®®æ¯æ¬¡å¤„ç†ä¸è¶…è¿‡10ç¯‡æ–‡çŒ®</li>
                </ul>
            </div>
             <button id="reset-btn" class="w-full text-center text-sm text-gray-500 hover:text-blue-600 hover:underline mt-4">è¿”å›é‡æ–°åˆ†æ</button>
        </div>

    </div>
    <script>
        // (ä¸­æ–‡æ³¨é‡Š) æ‰€æœ‰äº¤äº’é€»è¾‘éƒ½å°è£…åœ¨è¿™é‡Œ
        const formContainer = document.getElementById('form-container');
        const resultContainer = document.getElementById('result-container');
        const form = document.getElementById('upload-form');
        const submitBtn = document.getElementById('submit-btn');
        const dropZone = document.getElementById('drop-zone');
        const pdfsInput = document.getElementById('pdfs-input');
        const fileListDisplay = document.getElementById('file-list');
        const apiKeyInput = document.getElementById('api-key');
        const rememberKeyCheckbox = document.getElementById('remember-key');
        const modeSelector = document.getElementById('mode-selector');
        const modeInput = document.getElementById('mode-input');
        const customPromptContainer = document.getElementById('custom-prompt-container');
        
        const progressBar = document.getElementById('progress-bar');
        const resultList = document.getElementById('result-list');
        const finalResult = document.getElementById('final-result');
        const downloadBtn = document.getElementById('download-btn');
        const tipsContainer = document.getElementById('tips-container');
        const resetBtn = document.getElementById('reset-btn');
        let analysisResultBlob = null;

        // (ä¸­æ–‡æ³¨é‡Š) é¡µé¢åŠ è½½æ—¶ï¼Œè‡ªåŠ¨è¯»å–å·²ä¿å­˜çš„APIå¯†é’¥
        window.addEventListener('load', () => {
            const savedKey = localStorage.getItem('eggscan_api_key');
            if (savedKey) { apiKeyInput.value = savedKey; rememberKeyCheckbox.checked = true; }
        });

        // (ä¸­æ–‡æ³¨é‡Š) æ¨¡å¼åˆ‡æ¢çš„æ ¸å¿ƒé€»è¾‘
        modeSelector.addEventListener('click', (e) => {
            const selectedOption = e.target.closest('.mode-card');
            if (selectedOption) {
                modeSelector.querySelector('.active').classList.remove('active');
                selectedOption.classList.add('active');
                const selectedMode = selectedOption.dataset.mode;
                modeInput.value = selectedMode;
                customPromptContainer.classList.toggle('hidden', selectedMode !== 'è‡ªå®šä¹‰æ¨¡å¼');
            }
        });
        
        // (ä¸­æ–‡æ³¨é‡Š) æ–‡ä»¶æ‹–æ‹½å’Œé€‰æ‹©çš„äº¤äº’é€»è¾‘
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('border-blue-500'); });
        dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('border-blue-500'); });
        dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('border-blue-500'); pdfsInput.files = e.dataTransfer.files; updateFileList(); });
        dropZone.addEventListener('click', () => pdfsInput.click());
        pdfsInput.addEventListener('change', updateFileList);

        function updateFileList() {
            const fileCount = pdfsInput.files.length;
            fileListDisplay.textContent = fileCount > 0 ? `å·²é€‰æ‹© ${fileCount} ä¸ªæ–‡ä»¶` : 'ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤ (å¯å¤šé€‰)';
        }

        // (ä¸­æ–‡æ³¨é‡Š) è¡¨å•æäº¤çš„æ ¸å¿ƒå¤„ç†å‡½æ•°
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (rememberKeyCheckbox.checked) {
                localStorage.setItem('eggscan_api_key', apiKeyInput.value);
            } else {
                localStorage.removeItem('eggscan_api_key');
            }
            if (pdfsInput.files.length === 0) { alert('è¯·è‡³å°‘ä¸Šä¼ ä¸€ä¸ªPDFæ–‡ä»¶ã€‚'); return; }

            formContainer.classList.add('hidden');
            resultContainer.classList.remove('hidden');
            finalResult.classList.add('hidden');
            tipsContainer.classList.add('hidden');
            
            const totalFiles = pdfsInput.files.length;
            resultList.innerHTML = `<div class="text-sm text-gray-600">å…± ${totalFiles} ä¸ªæ–‡ä»¶ï¼Œæ­£åœ¨æäº¤ä»»åŠ¡...</div>`;
            progressBar.style.width = '5%';

            try {
                const formData = new FormData(form);
                progressBar.style.width = '20%';
                resultList.innerHTML += `<div class="text-sm text-gray-600 mt-2">æ­£åœ¨åˆ†æï¼Œè¯·è€å¿ƒç­‰å¾…... (è¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿ)</div>`;

                const response = await fetch('/analyze', { method: 'POST', body: formData });
                
                progressBar.style.width = '90%';

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `æœåŠ¡å™¨é”™è¯¯: ${response.status}`);
                }
                
                resultList.innerHTML = `<div class="result-item p-3 bg-green-50 rounded-lg text-sm text-green-700 font-semibold">âœ“ åˆ†æå®Œæˆï¼æŠ¥å‘Šå·²ç”Ÿæˆ</div>`;
                analysisResultBlob = await response.blob();
                finalResult.classList.remove('hidden');
                tipsContainer.classList.remove('hidden');
                progressBar.style.width = '100%';

            } catch (error) {
                resultList.innerHTML = `<div class="p-3 bg-red-100 border-l-4 border-red-500 rounded-lg text-red-700 font-semibold">âŒ åˆ†æå‡ºé”™: ${error.message}</div>`;
                progressBar.style.width = '100%';
                progressBar.style.backgroundColor = '#EF4444';
            }
        });

        // (ä¸­æ–‡æ³¨é‡Š) ä¸‹è½½æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
        downloadBtn.addEventListener('click', () => {
            if (analysisResultBlob) {
                const url = window.URL.createObjectURL(analysisResultBlob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'EggScan_Analysis_Result.xlsx';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            }
        });

        // (ä¸­æ–‡æ³¨é‡Š) è¿”å›æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
        resetBtn.addEventListener('click', () => {
            formContainer.classList.remove('hidden');
            resultContainer.classList.add('hidden');
            pdfsInput.value = '';
            updateFileList();
            progressBar.style.width = '0%';
            progressBar.style.backgroundColor = '';
        });
    </script>
</body>
</html>

